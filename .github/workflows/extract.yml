name: Extract from Cartola API

on:
  push:
    branches:
      - main
  schedule:
    - cron: 0 * * * *

permissions:
  contents: "read"
  id-token: "write"

jobs:
  extract:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        endpoint:
          - atletas/mercado
          - atletas/pontuados
          - clubes
          - mercado/destaques
          - mercado/selecao
          - partidas
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/506924123915/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@cartola-data.iam.gserviceaccount.com

      - name: Setup Google Cloud
        uses: google-github-actions/setup-gcloud@v1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install requirements
        run: pip install -r requirements.txt --disable-pip-version-check

      - name: Extract and load to Google Cloud Storage
        run: |
          STATUS=$(curl -s https://api.cartola.globo.com/mercado/status)
          SEASON=$(echo $STATUS | jq -r '.temporada')
          ROUND=$(printf %02d $(echo $STATUS | jq -r '.rodada_atual'))
          FILE=${{ matrix.endpoint }}/$SEASON-$ROUND.json
          python extract.py ${{ matrix.endpoint }} > data.json
          gcloud storage cp data.json gs://cartola/$FILE
